<!DOCTYPE html><html lang="zh-CN//语言"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> ⭐️并发编程【未看完】 · Note</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="⭐️并发编程【未看完】 - Dufy"><meta name="keywords"><meta name="author" content="Dufy"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Note"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul id="nav_list" class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div id="nav_btn" class="nav-btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">⭐️并发编程【未看完】</h1><div class="post-info">2021-03-25</div><div class="post-content"><a id="more"></a>



<h2 id="并发引入？"><a href="#并发引入？" class="headerlink" title="并发引入？"></a>并发引入？</h2><ul>
<li>提升程序运行速度</li>
<li>高级别+高薪必备</li>
</ul>
<h2 id="提速方法"><a href="#提速方法" class="headerlink" title="提速方法"></a>提速方法</h2><p><img src="https://i.loli.net/2021/03/28/DQof9OqpA1w62zv.png" alt="image-20210328164434462"></p>
<h2 id="python-中的支持"><a href="#python-中的支持" class="headerlink" title="python 中的支持"></a>python 中的支持</h2><p><img src="https://i.loli.net/2021/03/28/4QProBvHu5GXsFb.png" alt="image-20210328163529914"></p>
<ul>
<li>多线程Thread</li>
<li>多进程Process</li>
<li>多协程Coroutine</li>
</ul>
<h3 id="CPU-IO"><a href="#CPU-IO" class="headerlink" title="CPU/IO"></a>CPU/IO</h3><blockquote>
<p> CPU密集型（CPU-bound）</p>
</blockquote>
<p>任务的运行会受到CPU限制</p>
<p>也叫计算密集型，是指I/O在很短时间内就可以完成，CPU 需要大量的计算和处理，特点是CPU占有率相当高</p>
<p>如，压缩解压缩、加密解密、正则表达式搜索</p>
<blockquote>
<p>I/O密集型（I/O bound）</p>
</blockquote>
<p>指的是系统运作大部分状况是CPU在等I/O（磁盘）的读/写操作，CPU占有率低</p>
<p>如，文件处理程序、网络爬虫程序、读写数据库程序</p>
<h3 id="多线程、多进程、多协程对比"><a href="#多线程、多进程、多协程对比" class="headerlink" title="多线程、多进程、多协程对比"></a>多线程、多进程、多协程对比</h3><p><img src="https://i.loli.net/2021/03/28/3SWMluHdTJoNf89.png" alt="image-20210328171002727"></p>
<h3 id="python多进程、多线程模块"><a href="#python多进程、多线程模块" class="headerlink" title="python多进程、多线程模块"></a>python多进程、多线程模块</h3><ul>
<li>多进程</li>
</ul>
<p>不采用多进程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time, sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_task</span><span class="params">(filename)</span>:</span></span><br><span class="line">    print(<span class="string">'开始下载%s...'</span> % filename)</span><br><span class="line">    time_to_download = randint(<span class="number">5</span>, <span class="number">10</span>)</span><br><span class="line">    sleep(time_to_download)</span><br><span class="line">    print(<span class="string">'%s下载完成! 耗费了%d秒'</span> % (filename, time_to_download))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    start = time()</span><br><span class="line">    download_task(<span class="string">'Python从入门到住院.pdf'</span>)</span><br><span class="line">    download_task(<span class="string">'Peking Hot.avi'</span>)</span><br><span class="line">    end = time()</span><br><span class="line">    print(<span class="string">'总共耗费了%.2f秒.'</span> % (end - start))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>更换为多进程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> getpid</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time, sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_task</span><span class="params">(filename)</span>:</span></span><br><span class="line">    print(<span class="string">'启动下载进程，进程号[%d].'</span> % getpid())</span><br><span class="line">    print(<span class="string">'开始下载%s...'</span> % filename)</span><br><span class="line">    time_to_download = randint(<span class="number">5</span>, <span class="number">10</span>)</span><br><span class="line">    sleep(time_to_download)</span><br><span class="line">    print(<span class="string">'%s下载完成! 耗费了%d秒'</span> % (filename, time_to_download))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    start = time()</span><br><span class="line">    p1 = Process(target=download_task, args=(<span class="string">'Python从入门到住院.pdf'</span>, ))</span><br><span class="line">    p1.start()</span><br><span class="line">    p2 = Process(target=download_task, args=(<span class="string">'Peking Hot.avi'</span>, ))</span><br><span class="line">    p2.start()  <span class="comment"># start方法用来启动进程</span></span><br><span class="line">    p1.join()    <span class="comment"># join方法表示等待进程执行结束</span></span><br><span class="line">    p2.join()</span><br><span class="line">    end = time()</span><br><span class="line">    print(<span class="string">'总共耗费了%.2f秒.'</span> % (end - start))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们也可以使用subprocess模块中的类和函数来创建和启动子进程，然后通过管道来和子进程通信，这些内容我们不在此进行讲解，有兴趣的读者可以自己了解这些知识。</p>
</blockquote>
<ul>
<li>多线程</li>
</ul>
<p>目前的多线程开发推荐使用threading模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time, sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(filename)</span>:</span></span><br><span class="line">    print(<span class="string">'开始下载%s...'</span> % filename)</span><br><span class="line">    time_to_download = <span class="number">3</span></span><br><span class="line">    sleep(time_to_download)</span><br><span class="line">    print(<span class="string">'%s下载完成! 耗费了%d秒'</span> % (filename, time_to_download))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    start = time()</span><br><span class="line">    t1 = Thread(target=download, args=(<span class="string">'Python从入门到住院.pdf'</span>,))</span><br><span class="line">    t1.start()</span><br><span class="line">    t2 = Thread(target=download, args=(<span class="string">'Peking Hot.avi'</span>,))</span><br><span class="line">    t2.start()</span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line">    end = time()</span><br><span class="line">    print(<span class="string">'总共耗费了%.3f秒'</span> % (end - start))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>还可以通过继承<code>Thread</code>类的方式来创建自定义的线程类，然后再创建线程对象并启动线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time, sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadTask</span><span class="params">(Thread)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, filename)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self._filename = filename</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'开始下载%s...'</span> % self._filename)</span><br><span class="line">        time_to_download = <span class="number">3</span></span><br><span class="line">        sleep(time_to_download)</span><br><span class="line">        print(<span class="string">'%s下载完成! 耗费了%d秒'</span> % (self._filename, time_to_download))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    start = time()</span><br><span class="line">    t1 = DownloadTask(<span class="string">'Python从入门到住院.pdf'</span>)</span><br><span class="line">    t1.start()</span><br><span class="line">    t2 = DownloadTask(<span class="string">'Peking Hot.avi'</span>)</span><br><span class="line">    t2.start()</span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line">    end = time()</span><br><span class="line">    print(<span class="string">'总共耗费了%.2f秒.'</span> % (end - start))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="如何选择技术"><a href="#如何选择技术" class="headerlink" title="如何选择技术"></a>如何选择技术</h3><p><img src="https://i.loli.net/2021/03/28/yM7DtzBcZkJNA4L.png" alt="image-20210328171157746"></p>
<h2 id="临界资源和锁"><a href="#临界资源和锁" class="headerlink" title="临界资源和锁"></a>临界资源和锁</h2><blockquote>
<p>临界资源</p>
</blockquote>
<p>因为多个线程可以共享进程的内存空间，因此要实现多个线程间的通信相对简单，大家能想到的最直接的办法就是设置一个全局变量，多个线程共享这个全局变量即可。但是当多个线程共享同一个变量（我们通常称之为“资源”）的时候，很有可能产生不可控的结果从而导致程序失效甚至崩溃。<u>如果一个资源被多个线程竞争使用，那么我们通常称之为“<strong>临界资源”</strong></u></p>
<p>对“临界资源”的访问需要加上保护，否则资源会处于“混乱”的状态。</p>
<p>e.g.</p>
<p>100个线程向同一个银行账户转账（转入1元钱）的场景，在这个例子中，<strong>银行账户就是一个临界资源</strong>，在没有保护的情况下我们很有可能会得到错误的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._balance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(self, money)</span>:</span></span><br><span class="line">        <span class="comment"># 计算存款后的余额</span></span><br><span class="line">        new_balance = self._balance + money</span><br><span class="line">        <span class="comment"># 模拟受理存款业务需要0.01秒的时间</span></span><br><span class="line">        sleep(<span class="number">0.01</span>)</span><br><span class="line">        <span class="comment"># 修改账户余额</span></span><br><span class="line">        self._balance = new_balance</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._balance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddMoneyThread</span><span class="params">(Thread)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, account, money)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self._account = account</span><br><span class="line">        self._money = money</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._account.deposit(self._money)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    account = Account()</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="comment"># 创建100个存款的线程向同一个账户中存钱</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        t = AddMoneyThread(account, <span class="number">1</span>)</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="comment"># 等所有存款的线程都执行完毕</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line">    print(<span class="string">'账户余额为: ￥%d元'</span> % account.balance)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">账户余额为: ￥2元</span><br></pre></td></tr></table></figure>

<p>使用“锁”来保护对银行账户的操作，从而获得正确的结果:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Lock</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._balance = <span class="number">0</span></span><br><span class="line">        self._lock = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(self, money)</span>:</span></span><br><span class="line">        <span class="comment"># 先获取锁才能执行后续的代码</span></span><br><span class="line">        self._lock.acquire()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            new_balance = self._balance + money</span><br><span class="line">            sleep(<span class="number">0.01</span>)</span><br><span class="line">            self._balance = new_balance</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 在finally中执行释放锁的操作保证正常异常锁都能释放</span></span><br><span class="line">            self._lock.release()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._balance</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">账户余额为: ￥100元</span><br></pre></td></tr></table></figure>

<p>更多例子，参见：<a href="https://github.com/jackfrued/Python-100-Days/blob/master/Day01-15/13.%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B.md" target="_blank" rel="noopener">进程和线程之应用案例</a></p>
<blockquote>
<p>例子1：将耗时间的任务放到线程中以获得更好的用户体验。</p>
</blockquote>
<blockquote>
<p>例子2：使用多进程对复杂任务进行“分而治之”。</p>
</blockquote>
<h2 id="python-GIL"><a href="#python-GIL" class="headerlink" title="python GIL"></a>python GIL</h2><h3 id="Python-为何慢"><a href="#Python-为何慢" class="headerlink" title="Python 为何慢"></a>Python 为何慢</h3><ul>
<li>动态类型语言，边解释边执行</li>
<li>GIL</li>
</ul>
<h3 id="GIL"><a href="#GIL" class="headerlink" title="GIL"></a>GIL</h3><p><img src="https://i.loli.net/2021/03/28/TXYwu8inc6Pbv1Z.png" alt="image-20210328175254300"></p>
<p><a href="https://www.dabeaz.com/python/UnderstandingGIL.pdf" target="_blank" rel="noopener">https://www.dabeaz.com/python/UnderstandingGIL.pdf</a></p>
<h3 id="为何有GIL-？"><a href="#为何有GIL-？" class="headerlink" title="为何有GIL ？"></a>为何有GIL ？</h3><p><img src="https://i.loli.net/2021/03/28/HEBg5n4ok87VwWG.png" alt="image-20210328180022551"></p>
<h3 id="如何规避GIL"><a href="#如何规避GIL" class="headerlink" title="如何规避GIL?"></a>如何规避GIL?</h3><p><img src="https://i.loli.net/2021/03/30/JvMTSi9gwDoZmkR.png" alt="image-20210328180242946"></p>
<h2 id="多线程举例：爬虫"><a href="#多线程举例：爬虫" class="headerlink" title="多线程举例：爬虫"></a>多线程举例：爬虫</h2><ul>
<li>创建多线程</li>
</ul>
<p><img src="https://i.loli.net/2021/03/28/jVCh4HpUBdstmuo.png" alt="image-20210328185755984"></p>
<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Time : 2021/3/28 7:07 下午</span></span><br><span class="line"><span class="string">@Author : Dufy</span></span><br><span class="line"><span class="string">@Email : 813540660@qq.com</span></span><br><span class="line"><span class="string">@File : multi-thread-crawl.py</span></span><br><span class="line"><span class="string">@Software: PyCharm </span></span><br><span class="line"><span class="string">Description :</span></span><br><span class="line"><span class="string">1) 多线程网页加速效果展示</span></span><br><span class="line"><span class="string">2)       </span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">urls = [<span class="string">f"https://www.cnblogs.com/#p<span class="subst">&#123;i&#125;</span>"</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>+<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(url)</span>:</span></span><br><span class="line">    r= requests.get(url)</span><br><span class="line">    print(url, len(r.text))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_thread</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"single thread begin"</span>)</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        crawl(url)</span><br><span class="line">    print(<span class="string">"single thread end!!"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_thread</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""多线程"""</span></span><br><span class="line">    print(<span class="string">"multi thread begin"</span>)</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        threads.append(</span><br><span class="line">            threading.Thread(target=crawl, args=(url,))</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"multi thread end"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    single_thread()</span><br><span class="line">    end = time.time()</span><br><span class="line">    print(<span class="string">f'单线程花费：<span class="subst">&#123;end-start&#125;</span> s'</span>)</span><br><span class="line"></span><br><span class="line">    start = time.time()</span><br><span class="line">    multi_thread()</span><br><span class="line">    end = time.time()</span><br><span class="line">    print(<span class="string">f'多线程花费：<span class="subst">&#123;end - start&#125;</span> s'</span>)</span><br></pre></td></tr></table></figure>

<p>单线程花费：8.063177108764648 s</p>
<p>多线程花费：0.9351308345794678 s</p>
<h2 id="生产者-消费者模式的多线程爬虫"><a href="#生产者-消费者模式的多线程爬虫" class="headerlink" title="生产者-消费者模式的多线程爬虫"></a>生产者-消费者模式的多线程爬虫</h2><h3 id="多组件的Pipeline技术架构"><a href="#多组件的Pipeline技术架构" class="headerlink" title="多组件的Pipeline技术架构"></a>多组件的Pipeline技术架构</h3><p>复杂 的事情一般都不会一下子做完，而是会分很多中间步骤一步步完成</p>
<p><img src="https://i.loli.net/2021/03/28/IaHfnRpmYDhkAVX.png" alt="image-20210328193156516"></p>
<h3 id="生产者-消费者爬虫架构"><a href="#生产者-消费者爬虫架构" class="headerlink" title="生产者-消费者爬虫架构"></a>生产者-消费者爬虫架构</h3><p><img src="https://i.loli.net/2021/03/30/fvC54j1qVMY3HTB.png" alt="image-20210328193514491"></p>
<h3 id="多线程数据通信-queue-Queue"><a href="#多线程数据通信-queue-Queue" class="headerlink" title="多线程数据通信 queue.Queue"></a>多线程数据通信 <code>queue.Queue</code></h3><p><img src="https://i.loli.net/2021/03/28/QiT7xXMBcEFSydW.png" alt="image-20210328194115592"></p>
<ul>
<li>post 方法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Time : 2021/3/28 7:07 下午</span></span><br><span class="line"><span class="string">@Author : Dufy</span></span><br><span class="line"><span class="string">@Email : 813540660@qq.com</span></span><br><span class="line"><span class="string">@File : blog_crawl.py</span></span><br><span class="line"><span class="string">@Software: PyCharm </span></span><br><span class="line"><span class="string">Description :</span></span><br><span class="line"><span class="string">1) 基础版本展示</span></span><br><span class="line"><span class="string">2) post 方法 抓包</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = &#123;"CategoryType":"SiteHome","ParentCategoryId":0,"CategoryId":808,"PageIndex":3,"TotalPostCount":4000,"ItemListActionName":"AggSitePostList"&#125;</span></span><br><span class="line">header = &#123;<span class="string">'accept'</span>: <span class="string">'text/plain, */*; q=0.01'</span>,</span><br><span class="line">          <span class="string">'accept-encoding'</span>: <span class="string">'gzip, deflate, br'</span>,</span><br><span class="line">          <span class="string">'accept-language'</span>: <span class="string">'zh-CN,zh;q=0.9,en;q=0.8'</span>,</span><br><span class="line">          <span class="string">'content-type'</span>: <span class="string">'application/json; charset=UTF-8'</span>,</span><br><span class="line">          <span class="string">'origin'</span>: <span class="string">'https://www.cnblogs.com'</span>,</span><br><span class="line">          <span class="string">'referer'</span>: <span class="string">'https://www.cnblogs.com/'</span>,</span><br><span class="line">          <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82, Safari/537.36'</span>,</span><br><span class="line">          <span class="string">'x-requested-with'</span>: <span class="string">'XMLHttpRequest'</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(url, page_index)</span>:</span></span><br><span class="line">    r= requests.post(url,</span><br><span class="line">                     data = json.dumps(&#123;<span class="string">"CategoryType"</span>:<span class="string">"SiteHome"</span>,<span class="string">"ParentCategoryId"</span>:<span class="number">0</span>,<span class="string">"CategoryId"</span>:<span class="number">808</span>,<span class="string">"PageIndex"</span>:page_index,<span class="string">"TotalPostCount"</span>:<span class="number">4000</span>,<span class="string">"ItemListActionName"</span>:<span class="string">"AggSitePostList"</span>&#125;),</span><br><span class="line">                     headers = header)</span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(html)</span>:</span></span><br><span class="line">    <span class="comment"># class ="post-item-title"</span></span><br><span class="line">    soup =  BeautifulSoup(html, <span class="string">"html.parser"</span>)</span><br><span class="line">    links = soup.find_all(<span class="string">"a"</span>, class_ =<span class="string">"post-item-title"</span>)</span><br><span class="line">    <span class="keyword">return</span> [(link[<span class="string">'href'</span>], link.get_text())<span class="keyword">for</span> link <span class="keyword">in</span> links]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    page_index = <span class="number">10</span></span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> parse(crawl(<span class="string">'https://www.cnblogs.com/AggSite/AggSitePostList'</span>, page_index)):</span><br><span class="line">        print(result)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>links = soup.find_all(&quot;a&quot;, class_ =&quot;post-item-title&quot;)</code>来自于：</p>
</blockquote>
<p><img src="https://i.loli.net/2021/03/30/kAzKRuQPDY82JM6.png" alt="image-20210328194837397"></p>
<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Time : 2021/3/29 9:58 下午</span></span><br><span class="line"><span class="string">@Author : Dufy</span></span><br><span class="line"><span class="string">@Email : 813540660@qq.com</span></span><br><span class="line"><span class="string">@File : producer-consumer-spider.py</span></span><br><span class="line"><span class="string">@Software: PyCharm </span></span><br><span class="line"><span class="string">Description :</span></span><br><span class="line"><span class="string">1)  生产者、消费者模式爬虫</span></span><br><span class="line"><span class="string">2)       </span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> blog_crawl</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url  =<span class="string">'https://www.cnblogs.com/AggSite/AggSitePostList'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_crawl</span><span class="params">(url_queue:queue.Queue, html_queue:queue.Queue)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        index = url_queue.get()</span><br><span class="line">        html = blog_crawl.crawl(url,index)</span><br><span class="line">        html_queue.put(html)</span><br><span class="line">        print(threading.current_thread().name, <span class="string">f'crawl<span class="subst">&#123;url&#125;</span>'</span>,</span><br><span class="line">              <span class="string">'url_queue.size='</span>, url_queue.qsize())</span><br><span class="line">        time.sleep(random.randint(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_parse</span><span class="params">(html_queue:queue.Queue, fout)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        html = html_queue.get()</span><br><span class="line">        results = blog_crawl.parse(html)</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            fout.write(str(result)+<span class="string">'\n'</span>)</span><br><span class="line">        print(threading.current_thread().name, <span class="string">f'results.size'</span>, len(results),</span><br><span class="line">                  <span class="string">'html_queue.size='</span>, html_queue.qsize())</span><br><span class="line">        time.sleep(random.randint(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    url_queue = queue.Queue()</span><br><span class="line">    html_queue = queue.Queue()</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">15</span>):</span><br><span class="line">        url_queue.put(index)</span><br><span class="line">    <span class="keyword">for</span> thread_num <span class="keyword">in</span> range(<span class="number">3</span>):  <span class="comment"># 生产者线程</span></span><br><span class="line">        t = threading.Thread(target=do_crawl,</span><br><span class="line">                             args=(url_queue, html_queue),</span><br><span class="line">                             name=<span class="string">f'crawl<span class="subst">&#123;thread_num&#125;</span>'</span>)</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    fout = open(<span class="string">'data.txt'</span>, <span class="string">'w'</span>)  <span class="comment"># 文件输出</span></span><br><span class="line">    <span class="keyword">for</span> thread_num <span class="keyword">in</span> range(<span class="number">2</span>): <span class="comment"># 消费者线程</span></span><br><span class="line">        t = threading.Thread(target=do_parse,</span><br><span class="line">                             args=(html_queue, fout),</span><br><span class="line">                             name=<span class="string">f'parse<span class="subst">&#123;thread_num&#125;</span>'</span>)</span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure>

<p>结果写到 data.txt中</p>
<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p>…..</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://www.bilibili.com/video/BV1bK411A7tV?p=6&spm_id_from=pageDriver" target="_blank" rel="noopener">【2021最新版】Python 并发编程实战，用多线程、多进程、多协程加速程序运行</a><img src="https://i.loli.net/2021/03/30/6MqJLlXFEh5yYKR.png" alt="image-20210330220406017"></li>
</ol>
</div></article></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2021/04/02/数据结构与算法之美（高级篇）/" title="⭐️数据结构与算法之美（高级篇 &amp; 实战篇）" class="prev">上一篇</a><a href="/2021/03/08/趣代码/" title="⭐️趣代码" class="next">下一篇</a></div><div class="copyright"><p>© 2019 - 2021 <a target="_blank">Dufy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p> <span style="padding-right: 6px;">闽ICP备16007301号-2</span></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/ar-anchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>